
function astroquery -d "Interact with astroquery from fish shell"
    if test (count $argv) -eq 0
        echo "Available astroquery commands:"
        echo "  astroquery list       # List all available astroquery services"
        echo "  astroquery simbad     # Query SIMBAD database"
        echo "  astroquery vizier     # Query VizieR catalogs"
        echo "  astroquery gaia       # Query Gaia database"
        echo "  astroquery skyview    # Get images from SkyView"
        echo "  astroquery ned        # Query NED database"
        echo "  astroquery jplhorizons # Query JPL Horizons for solar system objects"
        return 0
    end

    switch $argv[1]
        case "list"
            python -c "from astroquery import __all__; print('\n'.join(__all__))"
            
        case "*"
            echo "Unknown astroquery command: $argv[1]"
            echo "Run 'astroquery' without arguments to see available commands"
    end
end

function astroquery-simbad -d "Query SIMBAD astronomical database"
    if test (count $argv) -eq 0
        echo "Usage: astroquery-simbad [object_name]"
        echo "Example: astroquery-simbad 'M31'"
        return 1
    end
    
    python -c "
from astroquery.simbad import Simbad
import sys

try:
    result = Simbad.query_object('$argv[1]')
    if result is None:
        print(f'No results found for \"{argv[1]}\"')
    else:
        print(result)
except Exception as e:
    print(f'Error querying SIMBAD: {e}')
"
end

function astroquery-vizier -d "Query VizieR astronomical catalogs"
    if test (count $argv) -lt 2
        echo "Usage: astroquery-vizier [catalog_id] [object_name] (radius_arcmin)"
        echo "Example: astroquery-vizier 'II/246' 'M31' 10"
        return 1
    end
    
    set radius 5  
    if test (count $argv) -ge 3
        set radius $argv[3]
    end
    
    python -c "
from astroquery.vizier import Vizier
import astropy.units as u
import sys

try:
    v = Vizier(columns=['*', '+_r'])
    result = v.query_object('$argv[2]', catalog='$argv[1]', radius=$radius * u.arcmin)
    if not result:
        print(f'No results found for \"{argv[2]}\" in catalog \"{argv[1]}\"')
    else:
        for table_name in result.keys():
            print(f'\\nTable: {table_name}')
            print(result[table_name])
except Exception as e:
    print(f'Error querying VizieR: {e}')
"
end

function astroquery-gaia -d "Query Gaia database"
    if test (count $argv) -lt 1
        echo "Usage: astroquery-gaia [object_name] (radius_arcsec)"
        echo "Example: astroquery-gaia 'Sirius' 30"
        return 1
    end
    
    set radius 10  
    if test (count $argv) -ge 2
        set radius $argv[2]
    end
    
    python -c "
from astroquery.gaia import Gaia
from astroquery.simbad import Simbad
import astropy.units as u
import astropy.coordinates as coord
import sys

try:
    result = Simbad.query_object('$argv[1]')
    if result is None:
        print(f'Object \"{argv[1]}\" not found in SIMBAD')
        sys.exit(1)
    
    ra = result['RA'][0]
    dec = result['DEC'][0]
    
    c = coord.SkyCoord(ra + ' ' + dec, unit=(u.hourangle, u.deg))
    
    r = $radius * u.arcsec
    j = Gaia.cone_search_async(c, r)
    result = j.get_results()
    
    if len(result) == 0:
        print(f'No Gaia results found for \"{argv[1]}\" within {r}')
    else:
        print(f'Found {len(result)} sources in Gaia DR3:')
        cols = ['source_id', 'ra', 'dec', 'parallax', 'pmra', 'pmdec', 'phot_g_mean_mag', 'bp_rp']
        print(result[cols])
except Exception as e:
    print(f'Error querying Gaia: {e}')
"
end

function astroquery-skyview -d "Get images from SkyView"
    if test (count $argv) -lt 1
        echo "Usage: astroquery-skyview [object_name] (survey) (output_file)"
        echo "Example: astroquery-skyview 'M51' 'DSS' './m51_dss.fits'"
        echo "Available surveys: DSS, DSS2, 2MASS, WISE, SDSS, etc."
        return 1
    end
    
    set survey "DSS"  
    if test (count $argv) -ge 2
        set survey $argv[2]
    end
    
    set output_file "$argv[1]_$survey.fits"  
    if test (count $argv) -ge 3
        set output_file $argv[3]
    end
    
    python -c "
from astroquery.skyview import SkyView
from astropy.io import fits
import matplotlib.pyplot as plt
import sys
try:
    object_name = '$argv[1]'
    survey_name = '$survey'
    output_file = '$output_file'
    
    print(f'Fetching {survey_name} image for {object_name}...')
    images = SkyView.get_images(position=object_name, survey=[survey_name])
    
    if not images or len(images) == 0 or images[0] is None:
        print(f'No images found for \"{object_name}\" in survey \"{survey_name}\"')
        sys.exit(1)
    
    fits.writeto(output_file, images[0][0].data, images[0][0].header, overwrite=True)
    print(f'Image saved to {output_file}')
    
    print(f'Image size: {images[0][0].data.shape}')
    print(f'To display this image, you can use DS9 or a Python script with matplotlib')
except Exception as e:
    print(f'Error getting image from SkyView: {e}')
"
end


function astroquery-ned -d "Query NASA/IPAC Extragalactic Database"
    if test (count $argv) -eq 0
        echo "Usage: astroquery-ned [object_name]"
        echo "Example: astroquery-ned 'NGC 1275'"
        return 1
    end
    
    python -c "
from astroquery.ipac.ned import Ned
import sys
try:
    object_name = '$argv[1]'
    print(f'Querying NED for {object_name}...')
    
    result = Ned.query_object(object_name)
    if result is None or len(result) == 0:
        print(f'No results found for \"{object_name}\" in NED')
    else:
        print(result)
        
    print('\\nBasic data:')
    try:
        objdata = Ned.get_object_info(object_name)
        print(objdata)
    except Exception as e:
        print(f'Could not retrieve basic data: {e}')
        
except Exception as e:
    print(f'Error querying NED: {e}')
"
end

# Fixed NED database query function
function astroquery-ned -d "Query NASA/IPAC Extragalactic Database"
    if test (count $argv) -eq 0
        echo "Usage: astroquery-ned [object_name]"
        echo "Example: astroquery-ned 'NGC 1275'"
        return 1
    end
    
    python -c "
from astroquery.ipac.ned import Ned  # Updated import path
import sys

try:
    object_name = '$argv[1]'
    result = Ned.query_object(object_name)
    if result is None or len(result) == 0:
        print(f'No results found for \"{object_name}\" in NED')
    else:
        print(result)
        
    # Get basic parameters
    print('\\nBasic data:')
    try:
        objdata = Ned.get_object_info(object_name)
        print(objdata)
    except Exception as e:
        print(f'Could not retrieve basic data: {e}')
        
except Exception as e:
    print(f'Error querying NED: {e}')
"
end

function astroquery-jplhorizons -d "Query JPL Horizons for solar system objects"
    if test (count $argv) -lt 1
        echo "Usage: astroquery-jplhorizons [object_id] (start_time) (stop_time) (step)"
        echo "Example: astroquery-jplhorizons '301' '2023-01-01' '2023-01-10' '1d'"
        echo "Object IDs: 1=Mercury, 301=Moon, 399=Earth, 499=Mars, 599=Jupiter, etc."
        echo "            Or use names like 'Mars', 'Ceres', 'C/2020 F3' (comet)"
        return 1
    end
    
    set object_id $argv[1]
    set start_time "2023-01-01"  # Default start time
    set stop_time "2023-01-10"   # Default end time
    set step "1d"                # Default step (1 day)
    
    if test (count $argv) -ge 2
        set start_time $argv[2]
    end
    
    if test (count $argv) -ge 3
        set stop_time $argv[3]
    end
    
    if test (count $argv) -ge 4
        set step $argv[4]
    end
    
    python -c "
from astroquery.jplhorizons import Horizons
import sys
from tabulate import tabulate
import numpy as np
import pandas as pd

try:
    object_id = '$object_id'
    start_time = '$start_time'
    stop_time = '$stop_time'
    step = '$step'
    
    print(f'Querying JPL Horizons for object: {object_id}')
    print(f'Time range: {start_time} to {stop_time}, step: {step}')
    
    # Create Horizons object
    obj = Horizons(id=object_id, location='@sun', 
                  epochs={'start': start_time, 'stop': stop_time, 'step': step})
    
    # Get ephemeris
    eph = obj.ephemerides()
    
    if eph is None or len(eph) == 0:
        print(f'No ephemeris data found for \"{object_id}\"')
        sys.exit(1)
    
    # Display basic information
    print(f'\\nFound {len(eph)} positions for {object_id}')
    
    # Convert data to Pandas DataFrame and format output
    df = eph.to_pandas()
    
    # Select important columns
    columns = ['datetime_str', 'solar_presence', 'r', 'delta', 'lighttime', 'RA', 'DEC', 'V']
    columns = [col for col in columns if col in df.columns]
    
    # Format output
    print('\\nEphemeris data:')
    print(tabulate(df[columns].head(10), headers='keys', tablefmt='psql', showindex=False))
    
    if len(df) > 10:
        print(f'... and {len(df) - 10} more rows')
    
    # Get object details
    try:
        obj_data = Horizons(id=object_id, location='@sun').ephemerides(quantities=1)
        print('\\nObject information:')
        for key in ['targetname', 'H', 'G']:
            if key in obj_data.columns:
                print(f'{key}: {obj_data[key][0]}')
    except Exception as e:
        print(f'Could not retrieve object details: {e}')
        
except Exception as e:
    print(f'Error querying JPL Horizons: {e}')
    print(f'Tip: If the object ID is a comet or asteroid designation, make sure to use the correct format.')
    print(f'For comets use e.g. \"C/2020 F3\" and for asteroids use e.g. \"1 Ceres\" or \"(99942) Apophis\"')
"
end

function astroquery -d "Interact with astroquery from fish shell"
    if test (count $argv) -eq 0
        echo "Available astroquery commands:"
        echo "  astroquery list        # List all available astroquery services"
        echo "  astroquery simbad      # Query SIMBAD database"
        echo "  astroquery vizier      # Query VizieR catalogs"
        echo "  astroquery gaia        # Query Gaia database"
        echo "  astroquery skyview     # Get images from SkyView"
        echo "  astroquery ned         # Query NED database"
        echo "  astroquery jplhorizons # Query JPL Horizons for solar system objects"
        return 0
    end

    switch $argv[1]
        case "list"
            python -c "from astroquery import __all__; print('\n'.join(__all__))"
        case "simbad"
            astroquery-simbad $argv[2..-1]
        case "vizier"
            astroquery-vizier $argv[2..-1]
        case "gaia"
            astroquery-gaia $argv[2..-1]
        case "skyview"
            astroquery-skyview $argv[2..-1]
        case "ned"
            astroquery-ned $argv[2..-1]
        case "jplhorizons"
            astroquery-jplhorizons $argv[2..-1]
        case "*"
            echo "Unknown astroquery command: $argv[1]"
            echo "Run 'astroquery' without arguments to see available commands"
    end
end

complete -c astroquery -f -n "__fish_use_subcommand" -a "list" -d "List all available astroquery services"
complete -c astroquery -f -n "__fish_use_subcommand" -a "simbad" -d "Query SIMBAD database"
complete -c astroquery -f -n "__fish_use_subcommand" -a "vizier" -d "Query VizieR catalogs"
complete -c astroquery -f -n "__fish_use_subcommand" -a "gaia" -d "Query Gaia database"
complete -c astroquery -f -n "__fish_use_subcommand" -a "skyview" -d "Get images from SkyView"
complete -c astroquery -f -n "__fish_use_subcommand" -a "ned" -d "Query NED database"
complete -c astroquery -f -n "__fish_use_subcommand" -a "jplhorizons" -d "Query JPL Horizons for solar system objects"

# SIMBAD subcommand completion
complete -c astroquery -f -n "__fish_seen_subcommand_from simbad" -a "--help" -d "Show help information"

# Completion suggestions for common astronomical targets
complete -c astroquery -f -n "__fish_seen_subcommand_from simbad" -a "M31" -d "Andromeda Galaxy"
complete -c astroquery -f -n "__fish_seen_subcommand_from simbad" -a "M42" -d "Orion Nebula"
complete -c astroquery -f -n "__fish_seen_subcommand_from simbad" -a "M87" -d "Virgo A Galaxy"
complete -c astroquery -f -n "__fish_seen_subcommand_from simbad" -a "Sirius" -d "Brightest star in night sky"
complete -c astroquery -f -n "__fish_seen_subcommand_from simbad" -a "Betelgeuse" -d "Red supergiant in Orion"

# VizieR subcommand completion
complete -c astroquery -f -n "__fish_seen_subcommand_from vCompletion suggestions for common catalogsizier" -a "--help" -d "Show help information"
# Completion suggestions for common catalogs
complete -c astroquery -f -n "__fish_seen_subcommand_from vizier" -a "II/246" -d "2MASS All-Sky Catalog"
complete -c astroquery -f -n "__fish_seen_subcommand_from vizier" -a "I/350" -d "Gaia DR3"
complete -c astroquery -f -n "__fish_seen_subcommand_from vizier" -a "I/345" -d "Gaia DR2"
complete -c astroquery -f -n "__fish_seen_subcommand_from vizier" -a "V/147" -d "SDSS DR12 Catalog"
complete -c astroquery -f -n "__fish_seen_subcommand_from vizier" -a "J/ApJS/199/26" -d "Kepler KOI Catalog"

# Gaia subcommand completion
complete -c astroquery -f -n "__fish_seen_subcommand_from gaia" -a "--help" -d "Show help information"
# Completion suggestions for common astronomical targets
complete -c astroquery -f -n "__fish_seen_subcommand_from gaia" -a "Sirius" -d "Brightest star in night sky"
complete -c astroquery -f -n "__fish_seen_subcommand_from gaia" -a "Proxima Centauri" -d "Nearest star to Solar System"
complete -c astroquery -f -n "__fish_seen_subcommand_from gaia" -a "Barnard Star" -d "High proper motion star"
complete -c astroquery -f -n "__fish_seen_subcommand_from gaia" -a "10" -d "Default radius (arcsec)"
complete -c astroquery -f -n "__fish_seen_subcommand_from gaia" -a "30" -d "Larger radius (arcsec)"
complete -c astroquery -f -n "__fish_seen_subcommand_from gaia" -a "60" -d "Extended radius (arcsec)"

# SkyView subcommand completion
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview" -a "--help" -d "Show help information"
# Completion suggestions for common astronomical targets
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview" -a "M51" -d "Whirlpool Galaxy"
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview" -a "M31" -d "Andromeda Galaxy"
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview" -a "M42" -d "Orion Nebula"
# Completion suggestions for common surveys
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview; and __fish_is_nth_token 2" -a "DSS" -d "Digitized Sky Survey"
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview; and __fish_is_nth_token 2" -a "DSS2" -d "Digitized Sky Survey 2"
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview; and __fish_is_nth_token 2" -a "2MASS" -d "2 Micron All Sky Survey"
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview; and __fish_is_nth_token 2" -a "WISE" -d "Wide-field Infrared Survey Explorer"
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview; and __fish_is_nth_token 2" -a "SDSS" -d "Sloan Digital Sky Survey"
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview; and __fish_is_nth_token 2" -a "GALEX" -d "Galaxy Evolution Explorer"
complete -c astroquery -f -n "__fish_seen_subcommand_from skyview; and __fish_is_nth_token 2" -a "Fermi" -d "Fermi Gamma-ray Space Telescope"

# NED subcommand completion
complete -c astroquery -f -n "__fish_seen_subcommand_from ned" -a "--help" -d "Show help information"
# Completion suggestions for common extragalactic objects
complete -c astroquery -f -n "__fish_seen_subcommand_from ned" -a "NGC 1275" -d "Perseus A"
complete -c astroquery -f -n "__fish_seen_subcommand_from ned" -a "M87" -d "Virgo A Galaxy"
complete -c astroquery -f -n "__fish_seen_subcommand_from ned" -a "NGC 5128" -d "Centaurus A"
complete -c astroquery -f -n "__fish_seen_subcommand_from ned" -a "3C 273" -d "Bright quasar"
complete -c astroquery -f -n "__fish_seen_subcommand_from ned" -a "Cygnus A" -d "Radio galaxy"

# JPL Horizons subcommand completion
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "--help" -d "Show help information"
# ompletion suggestions for Solar System objects
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "10" -d "Sun"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "1" -d "Mercury"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "2" -d "Venus"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "301" -d "Moon"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "399" -d "Earth"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "499" -d "Mars"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "599" -d "Jupiter"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "699" -d "Saturn"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "799" -d "Uranus"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "899" -d "Neptune"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "999" -d "Pluto"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "Ceres" -d "Dwarf planet"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons" -a "C/2020 F3" -d "Comet NEOWISE"

# Completion suggestions for date parameters (for JPL Horizons)
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons; and __fish_is_nth_token 2" -a "2023-01-01" -d "Start date"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons; and __fish_is_nth_token 3" -a "2023-01-10" -d "End date"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons; and __fish_is_nth_token 4" -a "1d" -d "Daily step"
complete -c astroquery -f -n "__fish_seen_subcommand_from jplhorizons; and __fish_is_nth_token 4" -a "1h" -d "Hourly step"
